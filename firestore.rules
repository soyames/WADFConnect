rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'organizer'];
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isEvaluator() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'organizer', 'evaluator'];
    }

    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Tickets collection
    match /tickets/{ticketId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Proposals collection
    match /proposals/{proposalId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow delete: if isAdmin();
    }

    // Sponsorships collection
    match /sponsorships/{sponsorshipId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow delete: if isAdmin();
    }

    // Sessions collection
    match /sessions/{sessionId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Ratings collection
    match /ratings/{ratingId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }

    // Certificates collection
    match /certificates/{certificateId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.userId) || isAdmin());
      allow write: if isAdmin();
    }

    // FAQs collection
    match /faqs/{faqId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }

    // Connections collection
    match /connections/{connectionId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.requesterId) || 
         isOwner(resource.data.addresseeId) || 
         isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (isOwner(resource.data.requesterId) || 
         isOwner(resource.data.addresseeId));
      allow delete: if isAdmin();
    }

    // Conversations collection
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && 
        (isOwner(resource.data.participant1Id) || 
         isOwner(resource.data.participant2Id) || 
         isAdmin());
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (isOwner(resource.data.participant1Id) || 
         isOwner(resource.data.participant2Id));
      allow delete: if isAdmin();
    }

    // Messages collection
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && isOwner(resource.data.senderId);
      allow delete: if isAdmin();
    }

    // Analytics collections - admin only
    match /revenue_snapshots/{snapshotId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /engagement_metrics/{metricId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /sponsor_metrics/{metricId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /session_metrics/{metricId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // Team members collection
    match /team_members/{memberId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // CFP settings
    match /cfp_settings/{settingId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }

    // Ticket options
    match /ticket_options/{optionId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }

    // Sponsorship packages
    match /sponsorship_packages/{packageId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }

    // Page settings
    match /page_settings/{pageId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }

    // Tasks collection
    match /tasks/{taskId} {
      allow read: if isAdmin() || 
        (isAuthenticated() && resource.data.assignedTo == request.auth.uid);
      allow write: if isAdmin();
    }

    // Proposal evaluators
    match /proposal_evaluators/{evaluatorId} {
      allow read: if isEvaluator();
      allow write: if isAdmin();
    }

    // Proposal evaluations
    match /proposal_evaluations/{evaluationId} {
      allow read: if isEvaluator();
      allow create: if isEvaluator();
      allow update: if isEvaluator() && isOwner(resource.data.evaluatorId);
      allow delete: if isAdmin();
    }
  }
}
